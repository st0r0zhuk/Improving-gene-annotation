---
title: "Untitled"
output: html_document
date: "2025-08-04"
---



# merge
```{r}
all_tables <- read.csv("/work/vstorozhuk/export_to_git/Scripts_for_analysis_of_isoforms/classifications_support2.txt")
all_tables %<>% filter(structural_category != "fusion")

barcode01_manda <- all_tables %>% filter(Species == "Macaca mulatta", pipeline == "MANDALORION") %>% dplyr::select(isoform, structural_category, subcategory, Isoform_N_reads, within_CAGE_peak, dist_to_CAGE_peak)

gtf_manda <- fread("/work/vstorozhuk/data/iso_pipeline/pipeline_outputs/Barcode03/Barcode03_mandalorion_R2_sqanti_filter/isoforms.filtered.gtf",
            sep = "\t",
            header = FALSE,
            quote = "",
            fill = TRUE)

gtf_manda %<>% as.data.frame()


gtf_mandalorion_filtered <- gtf_manda %>%
  as.data.frame() %>%
  # 1. extract transcript_id & gene_id
  mutate(
    transcript_id = str_extract(V9, '(?<=transcript_id ")[^"]+'),
    gene_id       = str_extract(V9, '(?<=gene_id ")[^"]+'),
    gene_id = if_else(
      str_detect(gene_id, '^[0-9]+$'),
      paste0("Novel_", gene_id),
      gene_id
    ),
    V9 = str_replace(
      V9,
      '(?<=gene_id ")[^"]+(?=";)',
      gene_id
    )
  ) %>%
  # 2. filter to only the isoforms you care about
  filter(transcript_id %in% barcode01_manda$isoform) %>%
  # 3. join in all the extra stats columns
  left_join(barcode01_manda, by = c("transcript_id" = "isoform")) %>%
  # 4. explicitly tack each one onto V9
  mutate(
    V9 = paste0(
      V9,
      sprintf(';structural_category "%s"',       structural_category),
      sprintf(';subcategory "%s"',               subcategory),
      sprintf(';Isoform_N_reads "%s"',           Isoform_N_reads),
      sprintf(';within_CAGE_peak "%s"',          within_CAGE_peak),
      sprintf(';dist_to_CAGE_peak "%s"',         dist_to_CAGE_peak)
    )
  ) %>%
  # 5. drop the extras so youâ€™re back to 9 columns
  dplyr::select(V1:V9)

gtf_mandalorion_filtered$V2 <- "MANDALORION"

write.table(
  gtf_mandalorion_filtered,
  file = "/work/vstorozhuk/export_to_git/Scripts_for_merging_gtfs_and_qc/RheMac_intermediate/gtf_mandalorion_filtered.gtf",
  sep = "\t",
  quote = FALSE,
  col.names = FALSE,
  row.names = FALSE
)

```

```{bash}
mamba activate agat_env

agat_convert_sp_gff2gtf.pl \
  --in /work/vstorozhuk/export_to_git/Scripts_for_merging_gtfs_and_qc/RheMac_intermediate/gtf_mandalorion_filtered.gtf \
  --gtf_version 3 \
  -o /work/vstorozhuk/export_to_git/Scripts_for_merging_gtfs_and_qc/RheMac_intermediate/mandalorion_s2_isoforms.filtered.fixed_agat.gtf

```

```{bash}
mamba activate agat_env

# Reference
agat_convert_sp_gxf2gxf.pl \
  --gff /work/vstorozhuk/data/reference/GCF_003339765.1_Mmul_10_genomic_standardized.gtf \
  -o ref.std.gff3


# Long-read isoforms 
agat_convert_sp_gxf2gxf.pl \
  --gff mandalorion_s2_isoforms.filtered.fixed_agat.gtf \
  -o lr.std.gff3

```


```{bash}
grep -h -v '^#' ref.std.gff3 lr.std.gff3 > combined.gff3

agat_sp_fix_features_locations_duplicated.pl \
  --gff combined.gff3 \
  --model 1,3 \
  -o merged.with_isoforms.gff3

```

```{bash}

agat_convert_sp_gff2gtf.pl \
  --in merged.with_isoforms.gff3 \
  --gtf_version 3 \
  -o merged.with_isoforms.gtf

```

```{r}

library(dplyr)
library(GenomicRanges)
library(IRanges)
library(rtracklayer)

merged <- rtracklayer::readGFF("/work/vstorozhuk/export_to_git/Scripts_for_merging_gtfs_and_qc/RheMac_intermediate/merged.with_isoforms.gtf")
merged %<>% as.data.frame()
to_fix <- merged


# Find dominant transcript per gene
dom_map <- to_fix %>%
  group_by(gene_id) %>%
  summarise(
    dominant_tx = {
      vals <- isoform_N_reads
      if (all(is.na(vals))) NA_character_ else {
        idx <- which(vals == max(vals, na.rm = TRUE))
        transcript_id[idx[1]]
      }
    },
    has_reads = !all(is.na(isoform_N_reads)),
    .groups = "drop"
  )

# Join and assign Dominant
to_fix <- to_fix %>%
  left_join(dom_map, by = "gene_id") %>%
  mutate(
    Dominant = case_when(
      !has_reads ~ NA,                                     # no isoform_N_reads for this gene
      type != "transcript" ~ NA,                           # not a transcript row
      transcript_id == dominant_tx ~ TRUE,                 # dominant transcript
      TRUE ~ FALSE                                          # other transcript
    )
  ) %>%
  dplyr::select(-dominant_tx, -has_reads)



library(dplyr)

tail_cols <- c(
  "structural_category", "subcategory", "within_CAGE_peak",
  "dist_to_CAGE_peak", "isoform_N_reads", "Dominant",
  "anticodon", "part", "gene_synonym", "standard_name"
)

to_fix <- to_fix %>% relocate(any_of(tail_cols), .after = last_col())

#####

df <- to_fix %>%
  mutate(
    # GRanges uses "*" for unknown; GTF uses "."
    strand = ifelse(strand == ".", "*", strand),
    # Keep score/phase types tidy
    score  = suppressWarnings(as.numeric(score)),
    phase  = suppressWarnings(as.integer(phase)),
    # GTF attributes are strings; make booleans explicit
    Dominant = case_when(
      is.na(Dominant) ~ NA_character_,
      Dominant ~ "TRUE",
      TRUE ~ "FALSE"
    )
  )

# Build GRanges
gr <- GRanges(
  seqnames = df$seqid,
  ranges   = IRanges(start = df$start, end = df$end),
  strand   = df$strand
)

# Put everything else into mcols (these become GTF columns/attributes)
# Avoid reserved GRanges column names
reserved <- c("seqnames","ranges","strand","seqlevels","seqlengths","isCircular",
              "start","end","width","element","seqid")  # plus the three used above

mcols(gr) <- df %>%
  dplyr::select(-all_of(c("seqid","start","end","strand"))) %>%
  # Ensure plain atomic vectors (no lists)
  mutate(across(everything(), ~ if (is.list(.)) vapply(., toString, "") else .))

# Write GTF
export(gr, "/work/vstorozhuk/export_to_git/Scripts_for_merging_gtfs_and_qc/RheMac_intermediate/RheMac10_extended.gtf", format = "gtf")

```


LOC706608 - pseudogene, likely reads are not alinged anymore, still in gtf
LOC114671164 - single exons transcript, which becomes reannotated as exon of a neighboring gene


# plot
```{r}
gtf_refseq   <- rtracklayer::readGFF("/work/vstorozhuk/data/reference/GCF_003339765.1_Mmul_10_genomic_standardized.gtf")
gtf_produced <- rtracklayer::readGFF("/work/vstorozhuk/export_to_git/Scripts_for_merging_gtfs_and_qc/RheMac_intermediate/RheMac10_extended.gtf")
cage_peaks   <- read.delim("/work/vstorozhuk/data/CAGE/rheMac8_cage_peaks_in_RheMac10_RefSeq_coords.bed", header = F)
cage_peaks <- GRanges(
  seqnames = cage_peaks$V1,
  ranges   = IRanges(
    start = as.integer(cage_peaks$V2) + 1,  # BED start is 0-based
    end   = as.integer(cage_peaks$V3)       # BED end is 1-based
  ),
  strand   = cage_peaks$V6,
  mcols    = cage_peaks[, setdiff(names(cage_peaks), c("V1","V2","V3","V6")), drop = FALSE]
)


# Make sure isoform_N_reads are numeric (harmless if already)
gtf_produced$isoform_N_reads <- suppressWarnings(as.numeric(gtf_produced$isoform_N_reads))

# --- 1) Build exon tables; for produced, *carry over existing Dominant from transcript rows* ---
gtf_ref_exons <- subset(gtf_refseq, type == "exon" & !is.na(gene_id))

# Take transcript-level flags from the produced GTF
tx_flags <- gtf_produced |>
  subset(type == "transcript" & !is.na(gene_id) & !is.na(transcript_id)) |>
  as.data.frame() |>
  dplyr::select(gene_id, transcript_id, isoform_N_reads, Dominant)

# Join those flags onto exon rows (no recomputation of dominance)
gtf_prod_exons <- gtf_produced |>
  subset(type == "exon" & !is.na(gene_id)) |>
  as.data.frame() |>
  dplyr::left_join(tx_flags, by = c("gene_id", "transcript_id"),
                   suffix = c("", ".tx")) |>
  dplyr::mutate(
    # prefer transcript-level columns if exon-level existed (usually exon-level are NA)
    isoform_N_reads = dplyr::coalesce(isoform_N_reads.tx, isoform_N_reads),
    Dominant        = dplyr::coalesce(Dominant.tx, Dominant),
    # Dominant might be "TRUE"/"FALSE" strings; force logical
    Dominant        = as.logical(Dominant)
  ) |>
  dplyr::select(-dplyr::ends_with(".tx"))

# --- 2) Plot using the existing Dominant flag ---
suppressPackageStartupMessages({
  library(Gviz)
  library(GenomicRanges)
  library(IRanges)
  library(dplyr)
})

options(ucscChromosomeNames = FALSE)

plot_two_gtfs_with_cage <- function(gene_name,
                                    cage_peaks,
                                    gtf_ref_exons,
                                    gtf_prod_exons,
                                    genome    = "mCalJac1.2",
                                    buffer.bp = 25000) {

  # helper: build GRanges and keep meta we care about
  make_gr <- function(df, gene.col, tx.col) {
    if (!"isoform_N_reads" %in% names(df)) df$isoform_N_reads <- NA_real_
    if (!"Dominant"        %in% names(df)) df$Dominant        <- NA

    mcols <- df[, c(gene.col, tx.col, "isoform_N_reads", "Dominant")]
    colnames(mcols) <- c("gene", "transcript", "isoform_N_reads", "Dominant")

    GRanges(
      seqnames = df$seqid,
      ranges   = IRanges(start = df$start, end = df$end),
      strand   = df$strand,
      mcols
    )
  }

  ref.gr  <- make_gr(gtf_ref_exons,  "gene_id", "transcript_id")
  prod.gr <- make_gr(gtf_prod_exons, "gene_id", "transcript_id")

  ref.gene  <- ref.gr[ref.gr$gene  == gene_name]
  prod.gene <- prod.gr[prod.gr$gene == gene_name]
  if (length(ref.gene) == 0 && length(prod.gene) == 0) {
    stop("Gene '", gene_name, "' not found in either GTF.")
  }

  all.starts <- c(start(ref.gene),  start(prod.gene))
  all.ends   <- c(end(ref.gene),    end(prod.gene))
  plot.range <- IRanges(min(all.starts) - buffer.bp,
                        max(all.ends)   + buffer.bp)
  chr <- as.character(GenomeInfoDb::seqnames(if (length(ref.gene)) ref.gene else prod.gene)[1])
  region.gr <- GRanges(seqnames = chr, ranges = plot.range)

  ref.sub   <- subsetByOverlaps(ref.gr,   region.gr)
  prod.sub  <- subsetByOverlaps(prod.gr,  region.gr)
  peaks.sub <- subsetByOverlaps(cage_peaks, region.gr)

  # Use the already-present Dominant flag
  dom.sub <- prod.sub[
    prod.sub$gene == gene_name &
      !is.na(prod.sub$Dominant) &
      prod.sub$Dominant
  ]

  col_ref  <- ifelse(ref.sub$gene  == gene_name, "orange", "gray80")
  col_prod <- ifelse(prod.sub$gene == gene_name, "orange", "gray80")

  tr_ref  <- GeneRegionTrack(
    ref.sub, genome = genome, chromosome = chr,
    name = "RefSeq", transcriptAnnotation = "transcript",
    showId = TRUE, background.title = "lightblue",
    fill = col_ref
  )

  tr_prod <- GeneRegionTrack(
    prod.sub, genome = genome, chromosome = chr,
    name = "RefSeq + Novel Isoforms", transcriptAnnotation = "transcript",
    showId = TRUE, background.title = "lightgoldenrod",
    fill = col_prod
  )

  tr_dom <- GeneRegionTrack(
    dom.sub, genome = genome, chromosome = chr,
    name = "Dominant (pre-flagged)", transcriptAnnotation = "transcript",
    showId = TRUE, background.title = "lightpink",
    fill = if (length(dom.sub) > 0) "purple" else NA
  )

  tr_peaks <- AnnotationTrack(
    peaks.sub, genome = genome, chromosome = chr,
    name = "CAGE", shape = "box", fill = "red",
    stacking = "dense", background.title = "pink"
  )

  highlight_all <- HighlightTrack(
    trackList  = list(tr_ref, tr_prod, tr_dom),
    start      = start(peaks.sub) - 50,
    end        = end(peaks.sub) + 50,
    chromosome = chr,
    col        = NA,
    fill       = "yellow"
  )

  plotTracks(
    list(highlight_all, tr_peaks),
    from       = start(plot.range),
    to         = end(plot.range),
    chromosome = chr,
    main       = paste0("Gene: ", gene_name)
  )
}
```


```{r}
plot_two_gtfs_with_cage(
  gene_name      = "STMN2",
  cage_peaks     = cage_peaks,
  gtf_ref_exons  = gtf_ref_exons,
  gtf_prod_exons = gtf_prod_exons
)
```

